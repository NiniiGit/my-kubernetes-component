name: Scorecard Check

on:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  scorecard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install pyyaml

      # Pin to tag instead of main (important)
      - name: Checkout platform standards (pinned)
        uses: actions/checkout@v4
        with:
          repository: NiniiGit/platform-standards
          ref: v0.1.1
          path: platform-standards
          token: ${{ secrets.PLATFORM_STANDARDS_PAT }}
          fetch-depth: 1

      - name: Copy scorecard spec + evaluator
        run: |
          cp platform-standards/standards/scorecard.yaml scorecard.yaml
          cp platform-standards/scripts/scorecard_eval.py scorecard_eval.py
          chmod +x scorecard_eval.py

      - name: Evaluate (informational)
        run: |
          ./scorecard_eval.py . --scorecard scorecard.yaml --mode informational --json-out scorecard-result.json | tee scorecard-output.txt

      - name: Scorecard Summary
        if: always()
        run: |
          echo "## Scorecard Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo '```text' >> "$GITHUB_STEP_SUMMARY"
          cat scorecard-output.txt >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

      - name: Upload scorecard result
        uses: actions/upload-artifact@v4
        with:
          name: scorecard-result
          path: |
            scorecard-result.json
            scorecard-output.txt

      - name: Write scorecard to repo folder
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          mkdir -p scorecards
          cp scorecard-result.json scorecards/latest.json
          cp scorecard-output.txt scorecards/latest.txt

      - name: Commit and push scorecard results
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          # prevent infinite loops: do not run if this commit was created by the scorecard bot
          if git log -1 --pretty=%B | grep -q "\[scorecard\]"; then
            echo "Last commit is a scorecard commit; skipping to avoid loop."
            exit 0
          fi

          git status --porcelain

          # Only commit if something actually changed
          if git diff --quiet -- scorecards/latest.json scorecards/latest.txt; then
            echo "No changes in scorecard outputs. Skipping commit."
            exit 0
          fi

          git config user.name "scorecard-bot"
          git config user.email "scorecard-bot@users.noreply.github.com"

          git add scorecards/latest.json scorecards/latest.txt
          git commit -m "[scorecard] update latest scorecard results"
          git push
